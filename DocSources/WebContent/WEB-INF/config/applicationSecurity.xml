<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:security="http://www.springframework.org/schema/security"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
    http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.0.3.xsd">

    <security:global-method-security secured-annotations="enabled" />

    <security:http auto-config="true">
        <security:intercept-url pattern="/login*" access="IS_AUTHENTICATED_ANONYMOUSLY" />
        <security:intercept-url pattern="/LoginUser" access="IS_AUTHENTICATED_ANONYMOUSLY" />
        <security:intercept-url pattern="/LogoutUser" access="IS_AUTHENTICATED_ANONYMOUSLY" />
        <security:intercept-url pattern="/css/**" access="IS_AUTHENTICATED_ANONYMOUSLY" />
        <security:intercept-url pattern="/images/**" access="IS_AUTHENTICATED_ANONYMOUSLY" />
        <security:intercept-url pattern="/scripts/**" access="IS_AUTHENTICATED_ANONYMOUSLY" />
        <security:intercept-url pattern="/user/ActivateUser.do" access="IS_AUTHENTICATED_ANONYMOUSLY" />
        <security:intercept-url pattern="/user/RegisterUser.do" access="IS_AUTHENTICATED_ANONYMOUSLY" />
        <security:intercept-url pattern="/user/ResetUserPassword.do" access="IS_AUTHENTICATED_ANONYMOUSLY" />
        <security:intercept-url pattern="/user/SendUserActivationCode.do" access="IS_AUTHENTICATED_ANONYMOUSLY" />
        <security:intercept-url pattern="/user/SendUserPasswordReset.do" access="IS_AUTHENTICATED_ANONYMOUSLY" />
        <security:intercept-url pattern="/user/ajax/**.do" access="IS_AUTHENTICATED_ANONYMOUSLY" />

        <security:intercept-url pattern="/adm/**"   access="ROLE_ADMINISTRATORS" />
        <security:intercept-url pattern="/de/**"    access="ROLE_ADMINISTRATORS, ROLE_ONSITE_FELLOWS, ROLE_DISTANT_FELLOWS" />
        <security:intercept-url pattern="/dev/**"   access="ROLE_ADMINISTRATORS, ROLE_ONSITE_FELLOWS" />
        <security:intercept-url pattern="/devd/**"  access="ROLE_ADMINISTRATORS, ROLE_ONSITE_FELLOWS" />
        <security:intercept-url pattern="/src/**"   access="ROLE_ADMINISTRATORS, ROLE_ONSITE_FELLOWS, ROLE_DISTANT_FELLOWS, ROLE_COMMUNITY_USERS, ROLE_DIGITIZATION_USERS, ROLE_GUESTS" />
        <security:intercept-url pattern="/mview/**" access="ROLE_ADMINISTRATORS, ROLE_ONSITE_FELLOWS, ROLE_DISTANT_FELLOWS, ROLE_COMMUNITY_USERS, ROLE_DIGITIZATION_USERS" />
        <security:intercept-url pattern="/cm/**"    access="ROLE_ADMINISTRATORS, ROLE_ONSITE_FELLOWS, ROLE_DISTANT_FELLOWS, ROLE_COMMUNITY_USERS, ROLE_DIGITIZATION_USERS" />
        <security:intercept-url pattern="/hl/**"    access="ROLE_ADMINISTRATORS" />
        <security:intercept-url pattern="/dig/**"   access="ROLE_ADMINISTRATORS, ROLE_DIGITIZATION_USERS" />
        
        <security:intercept-url pattern="/**.do" access="ROLE_ADMINISTRATORS, ROLE_ONSITE_FELLOWS, ROLE_DISTANT_FELLOWS, ROLE_COMMUNITY_USERS, ROLE_DIGITIZATION_USERS, ROLE_GUESTS" />
        <security:intercept-url pattern="/user/UpdateUser.do" access="ROLE_ADMINISTRATORS, ROLE_ONSITE_FELLOWS, ROLE_DISTANT_FELLOWS, ROLE_COMMUNITY_USERS, ROLE_DIGITIZATION_USERS, ROLE_GUESTS" />
        <security:intercept-url pattern="/user/ShowUserPhoto.do" access="ROLE_ADMINISTRATORS, ROLE_ONSITE_FELLOWS, ROLE_DISTANT_FELLOWS, ROLE_COMMUNITY_USERS, ROLE_DIGITIZATION_USERS, ROLE_GUESTS" />

		<security:intercept-url pattern="/user/**.do" access="ROLE_ADMINISTRATORS" />

        <security:form-login login-page="/LoginUser.do"
                    login-processing-url="/loginProcess" 
                    default-target-url="/Home.do"
                    authentication-failure-url="/LoginUser.do?login_error=1" />
  
        <security:logout invalidate-session="true" logout-url="/LogoutUser.do" logout-success-url="/LoginUser.do" />
		<security:session-management session-fixation-protection="newSession" />
		<security:remember-me key="docSources" user-service-ref="ldapUserDetailsService"/>
    </security:http>

	<security:authentication-manager>
		<security:authentication-provider ref="guestAuthenticationProvider">
		</security:authentication-provider>
		<security:authentication-provider ref="ldapAuthenticationProvider" >
			<security:password-encoder ref="passwordLdapShaEncoder"/>
		</security:authentication-provider>
	</security:authentication-manager>

	<bean id="passwordLdapShaEncoder" class="org.springframework.security.authentication.encoding.LdapShaPasswordEncoder">
		<description>Encoder for sha1 password stored on ldap server.</description>
	</bean>

	<bean id="springSecurityAuthenticationSource" class="org.springframework.security.ldap.authentication.SpringSecurityAuthenticationSource"/>
   
   	<bean id="authenticationSource" class="org.springframework.ldap.authentication.DefaultValuesAuthenticationSourceDecorator">
		<property name="target" ref="springSecurityAuthenticationSource" />
   		<property name="defaultUser" value="cn=Administrator,ou=Users,dc=docsources,dc=medici,dc=org" />
   		<property name="defaultPassword" value="!admin" />
   	</bean> 
   	
   	<bean id="securityContextSource" class="org.springframework.security.ldap.DefaultSpringSecurityContextSource">
   		<constructor-arg value="ldap://localhost:10389" />
   		<property name="authenticationSource" ref="authenticationSource"/>
   		<property name="baseEnvironmentProperties">
   			<map>
   				<entry key="com.sun.jndi.ldap.connect.timeout" value="60000" />
   				<entry key="java.naming.ldap.attributes.binary" value="objectGUID"/>
   			</map>
   		</property>
   	</bean>
   	
   	<bean id="contextSource" class="org.springframework.ldap.core.support.LdapContextSource">
		<property name="url" value="ldap://localhost:10389" />
		<property name="base" value="dc=docsources,dc=medici,dc=org" />
		<property name="userDn" value="cn=Administrator,ou=Users,dc=docsources,dc=medici,dc=org" />
		<property name="password" value="!admin" />
		<property name="baseEnvironmentProperties">
		<map>
			<entry key="com.sun.jndi.ldap.connect.timeout" value="60000" />
			<entry key="java.naming.ldap.attributes.binary" value="photo"/>
		</map>
   		</property>
	</bean>
	
   	<bean id="userSearch" class="org.springframework.security.ldap.search.FilterBasedLdapUserSearch">
   		<constructor-arg index="0">
   			<value>ou=Users,dc=docsources,dc=medici,dc=org</value>
   		</constructor-arg>
   		<constructor-arg index="1">
   			<value>cn={0}</value>
   		</constructor-arg>
   		<constructor-arg index="2">
   			<ref local="securityContextSource" />
   		</constructor-arg>
   		<property name="searchSubtree" value="true" />
   	</bean>
   
   	<bean id="bindAuthenticator" class="org.springframework.security.ldap.authentication.BindAuthenticator">
   		<constructor-arg>
   			<ref local="securityContextSource"/>
   		</constructor-arg>
   		<property name="userSearch" ref="userSearch" />
   	</bean>

	<bean id="guestAuthenticationProvider" class="org.springframework.security.authentication.dao.DaoAuthenticationProvider">
		<property name="userDetailsService" ref="guestUserDetailsServiceImpl"></property>
	</bean>

	<bean id="guestUserDetailsServiceImpl" class="org.medici.docsources.security.userdetails.DocSourcesGuestUserDetailsServiceImpl">
		<property name="userMap">
			<value>guest=guest,ROLE_GUESTS</value>
		</property> 
	</bean>

   	<bean id="ldapAuthenticationProvider" class="org.springframework.security.ldap.authentication.LdapAuthenticationProvider">
   		<constructor-arg index="0">
   			<ref local="bindAuthenticator" />
   		</constructor-arg>
   		<constructor-arg index="1">
   			<ref local="ldapAuthoritiesPopulator" />
   		</constructor-arg>
   		
   		<property name="userDetailsContextMapper" ref="ldapUserDetailsMapper"></property>
   	</bean>

	<bean id="ldapAuthoritiesPopulator" class="org.medici.docsources.security.DocSourcesAuthoritiesPopulator">
		<constructor-arg ref="contextSource"/>
		<constructor-arg value="ou=Groups"/>
		<property name="groupRoleAttribute" value="cn"/>
		<property name="searchSubtree" value="true"/>
		<property name="rolePrefix" value="ROLE_"/>
		<property name="convertToUpperCase" value="true"/>
		<property name="userAttributeForRole" value="member"/>
	</bean>
   	
   	<bean id="ldapUserDetailsService" class="org.springframework.security.ldap.userdetails.LdapUserDetailsService">
   		<constructor-arg index="0">
   			<ref local="userSearch" />
   		</constructor-arg>
   		<constructor-arg index="1">
   			<ref local="ldapAuthoritiesPopulator" />
   		</constructor-arg>
   		<property name="userDetailsMapper" ref="ldapUserDetailsMapper"></property>
   	</bean>

   	<bean id="ldapUserDetailsMapper" class="org.medici.docsources.security.DocSourcesLdapUserDetailsMapper"/>

    <bean id="ldapTemplate" class="org.springframework.ldap.core.LdapTemplate">
		<constructor-arg ref="contextSource" />
		<property name="ignorePartialResultException" value="true"/>
	</bean>

	<bean id="docSourcesLdapConfiguration" class="org.medici.docsources.security.DocSourcesLdapConfiguration">
		<property name="baseDN" value="dc=docsources,dc=medici,dc=org"/>
		<property name="usersDN" value="ou=Users"/>
		<property name="userAttribute" value="cn"></property>
		<property name="groupsDN" value="ou=Groups"/>
		<property name="roleAttribute" value="member"></property>
		<property name="roleAttributeValue" value="cn={0}"></property>
	</bean>
</beans>
